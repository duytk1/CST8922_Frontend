<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Project</title>
    <link rel="stylesheet" href="./css/styles.css">
    <script src="./js/config.js"></script>
    <script src="./js/auth.js"></script>
</head>
<body>
<div class="header">
    <h2>Multidisciplinary Project Request Platform</h2>
    <div class="header-right">
        <div class="school-info">
            <div>Algonquin College</div>
            <div>School of Advanced Technology</div>
        </div>
        <button onclick="logout()" class="logout-btn">Logout</button>
    </div>
</div>

<div class="main-container project-page">
    <div class="form-container project-form">
        <h2 class="project-title">Project Details</h2>
        <p class="form-note">Fields marked with <span class="required">*</span> are required</p>
        <form id="projectForm">
            <input type="hidden" id="projectId">
            <div class="form-group">
                <label for="projectName">Project Name <span class="required">*</span></label>
                <input type="text" id="projectName" placeholder="Enter here..." required>
            </div>
            <div class="form-group">
                <label for="description">Project Description <span class="required">*</span></label>
                <p class="field-note">We do not need full requirements, this description will be used to advertise your project to our students during the matching process. We need 3-5 sentences about what you are looking to achieve, please specify whether they will be building upon an existing product or creating one from scratch. If one exists and you are aware of the technology used, please provide those details as well. Full requirements will be gathered by the student team.</p>
                <textarea id="description" placeholder="Enter here..." required rows="4"></textarea>
            </div>
            <div class="form-group">
                <label for="availableTime">Time Available<span class="required">*</span></label>
                <p class="field-note">Please specify the number of hours you are available to collaborate with students each week. Successful projects typically involve 1-2 hours of communication to clarify requirements with the student team. We recommend scheduling a weekly meeting to discuss progress, clarify requirements, and address any questions.</p>
                <input type="number" id="availableTime" placeholder="Enter here..." required min="1">
            </div>
            <div class="form-group">
                <label for="purchasingRequirements">Purchasing Requirements</label>
                <p class="field-note">Does this project include any items that need to be purchased? If so, please list them. If not, you may leave this field blank.</p>
                <textarea id="purchasingRequirements" placeholder="Enter here..." rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="semester">Semester <span class="required">*</span></label>
                <p class="field-note">In which semester are you looking to get started?</p>
                <select id="semester" required>
                    <option value="" disabled selected>Select Semester</option>
                    <option value="FALL_2025">Fall 2025</option>
                    <option value="WINTER_2025">Winter 2025</option>
                    <option value="SPRING_2025">Spring 2025</option>
                    <option value="FALL_2026">Fall 2026</option>
                    <option value="WINTER_2026">Winter 2026</option>
                    <option value="SPRING_2026">Spring 2026</option>
                    <option value="FALL_2027">Fall 2027</option>
                    <option value="WINTER_2027">Winter 2027</option>
                    <option value="SPRING_2027">Spring 2027</option>
                    <option value="FALL_2028">Fall 2028</option>
                    <option value="WINTER_2028">Winter 2028</option>
                    <option value="SPRING_2028">Spring 2028</option>
                    <option value="FALL_2029">Fall 2029</option>
                    <option value="WINTER_2029">Winter 2029</option>
                    <option value="SPRING_2029">Spring 2029</option>
                    <option value="FALL_2030">Fall 2030</option>
                    <option value="WINTER_2030">Winter 2030</option>
                    <option value="SPRING_2030">Spring 2030</option>
                </select>
            </div>
            <div class="form-group">
                <label>NDA Requirement<span class="required">*</span></label>
                <p class="field-note">Please indicate if students are required to sign an NDA (Non-disclosure agreement) for this project.</p>
                <div class="radio-group">
                    <label class="radio-label">
                        <input type="radio" name="ndaRequired" value="true" required>
                        Yes
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="ndaRequired" value="false" required checked>
                        No
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label>Allow Project to be Showcased at Our Re/ACTION Event?<span class="required">*</span></label>
                <p class="field-note">Every semester, the student teams have an opportunity to showcase their work publicly during Applied Research Day (<a href="https://www.algonquincollege.com/applied-research/applied-research-day/" target="_blank">https://www.algonquincollege.com/applied-research/applied-research-day/</a>). Students are asked to create a poster which summarizes the project and then they are given a booth to demo the project to other students, faculty and industry attendees to highlight what they have built.</p>
                <div class="radio-group">
                    <label class="radio-label">
                        <input type="radio" name="showcaseAllowed" value="true" required checked>
                        Yes
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="showcaseAllowed" value="false" required>
                        No
                    </label>
                </div>
            </div>
            <div class="form-group button-group">
                <button type="submit" class="submit-btn">Update</button>
                <button type="button" class="cancel-btn" onclick="window.location.href='index.html'">Cancel</button>
            </div>
        </form>
        <div id="message" class="message-container"></div>

        <!-- Tag Management Section -->
        <div class="tag-management-section" id="tagManagementSection" style="display: none;">
            <h3>Manage Tags</h3>
            <div class="tag-labels">
                <div class="tag-type-label">Tag Type</div>
                <div class="tag-value-label">Tag Value</div>
            </div>
            <div id="tagSelectionContainer">
                <div class="tag-selection-row">
                    <div class="tag-type-container">
                        <select class="tag-type-select">
                            <option value="" disabled selected>Select Tag Type</option>
                        </select>
                    </div>
                    <div class="tag-value-container">
                        <div class="tag-value-group">
                            <select class="tag-value-select">
                                <option value="" disabled selected>Select Tag Value</option>
                            </select>
                            <button class="add-tag-btn" onclick="addTagRow(this)">+</button>
                            <button class="remove-tag-btn" onclick="removeTagRow(this)">−</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tag-save-container">
                <button onclick="saveAllTags()" class="save-tags-btn">Save</button>
            </div>
        </div>

        <!-- Back to List Button -->
        <div class="back-button-container" id="backButtonContainer" style="display: none;">
            <button onclick="window.location.href='index.html'" class="back-btn">Back to List</button>
        </div>
    </div>
</div>

<footer class="footer">
    <p>© 2025 Algonquin College - School of Advanced Technology. All rights reserved.</p>
</footer>

<script>
    window.addEventListener('load', async function() {
        if (!checkAuthentication()) return;

        const userInfo = JSON.parse(localStorage.getItem('userInfo'));
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('id');
        const viewMode = urlParams.get('mode') === 'view';

        if (!projectId) {
            alert('Project ID is required');
            window.location.href = 'index.html';
            return;
        }

        // Show/hide tag management section and back button based on user type
        const tagManagementSection = document.getElementById('tagManagementSection');
        const backButtonContainer = document.getElementById('backButtonContainer');
        if (userInfo.type === "PROFESSOR") {
            tagManagementSection.style.display = 'block';
            backButtonContainer.style.display = 'block';
            await loadTagTypes();
            await loadProjectTags();
        }

        try {
            const response = await fetch(`${API_BASE_URL}/project/${projectId}`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            });

            if (!response.ok) {
                throw new Error('Failed to fetch project details');
            }

            const project = await response.json();
            
            // Populate form fields
            document.getElementById('projectId').value = projectId;
            document.getElementById('projectName').value = project.projectName;
            document.getElementById('description').value = project.description;
            document.getElementById('availableTime').value = project.availableTime;
            document.getElementById('purchasingRequirements').value = project.purchasingRequirements || '';
            document.getElementById('semester').value = project.semester;
            document.querySelector(`input[name="ndaRequired"][value="${project.ndaRequired}"]`).checked = true;
            document.querySelector(`input[name="showcaseAllowed"][value="${project.showcaseAllowed}"]`).checked = true;

            // If in view mode or user is professor, disable all form elements
            if (viewMode || userInfo.type === 'PROFESSOR') {
                const form = document.getElementById('projectForm');
                form.classList.add('form-disabled');
                
                const formElements = form.querySelectorAll('input, textarea, select');
                formElements.forEach(element => {
                    element.disabled = true;
                });

                document.querySelector('.project-title').textContent = 'Project Details';

                if (userInfo.type === 'PROFESSOR') {
                    document.querySelector('.back-btn').style.display = 'block';
                }
            }

        } catch (error) {
            console.error('Error:', error);
            document.getElementById('message').innerHTML = `<p class="error">Error: ${error.message}</p>`;
        }
    });

    document.getElementById('projectForm').addEventListener('submit', async function(event) {
        event.preventDefault();

        const messageDiv = document.getElementById('message');
        const projectId = document.getElementById('projectId').value;

        const projectData = {
            id: projectId,
            projectName: document.getElementById('projectName').value.trim(),
            description: document.getElementById('description').value.trim(),
            availableTime: parseInt(document.getElementById('availableTime').value),
            purchasingRequirements: document.getElementById('purchasingRequirements').value.trim() || null,
            ndaRequired: document.querySelector('input[name="ndaRequired"]:checked').value === 'true',
            showcaseAllowed: document.querySelector('input[name="showcaseAllowed"]:checked').value === 'true',
            semester: document.getElementById('semester').value
        };

        try {
            const response = await fetch(`${API_BASE_URL}/project`, {
                method: 'PUT',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify(projectData)
            });

            const responseData = await response.json();

            if (response.ok) {
                messageDiv.innerHTML = '<p class="success">Project updated successfully!</p>';
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
            } else {
                if (Array.isArray(responseData)) {
                    const errorMessages = responseData.map(error => `${error.message}`).join(', ');
                    messageDiv.innerHTML = `<p class="error">Error: ${errorMessages}</p>`;
                } else {
                    messageDiv.innerHTML = `<p class="error">Error: ${responseData.message || 'Failed to update project'}</p>`;
                }
            }
        } catch (error) {
            console.error('Error updating project:', error);
            messageDiv.innerHTML = `<p class="error">Error: ${error.message}</p>`;
        }
    });

    function logout() {
        localStorage.removeItem('token');
        localStorage.removeItem('userInfo');
        window.location.href = 'login.html';
    }

    // Tag Management Functions
    let tagTypes = [];
    let tagValues = {};
    let currentProjectTags = [];

    async function loadTagTypes() {
        try {
            const response = await fetch(`${API_BASE_URL}/tag_value`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            });
            const valueData = await response.json();
            console.log('Tag Values:', valueData);
            
            const uniqueTypes = [...new Set(valueData.map(tag => tag.tagType))];
            console.log('Unique Tag Types:', uniqueTypes);
            
            const groupedTags = {};
            uniqueTypes.forEach(type => {
                groupedTags[type] = valueData
                    .filter(value => value.tagType === type)
                    .map(value => ({
                        id: value.id,
                        value: value.tagValue
                    }));
            });
            console.log('Grouped Tags:', groupedTags);

            tagValues = groupedTags;
            
            const typeSelects = document.querySelectorAll('.tag-type-select');
            typeSelects.forEach(select => {
                select.innerHTML = '<option value="" disabled selected>Select Tag Type</option>';
                Object.keys(tagValues).forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    select.appendChild(option);
                });
            });

            if (currentProjectTags && currentProjectTags.length > 0) {
                displayProjectTags();
            }
        } catch (error) {
            console.error('Error loading tag types:', error);
        }
    }

    function initializeTagSelects() {
        const firstRow = document.querySelector('.tag-selection-row');
        const typeSelect = firstRow.querySelector('.tag-type-select');
        
        typeSelect.innerHTML = '<option value="" disabled selected>Select Tag Type</option>';
        Object.keys(tagValues).forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = type;
            typeSelect.appendChild(option);
        });

        typeSelect.addEventListener('change', (e) => updateTagValueSelect(e.target));
    }

    function updateTagValueSelect(typeSelect) {
        const row = typeSelect.closest('.tag-selection-row');
        const valueSelect = row.querySelector('.tag-value-select');
        const selectedType = typeSelect.value;

        console.log('Updating tag value select for type:', selectedType);
        console.log('Available tag values for type:', tagValues[selectedType]);

        valueSelect.innerHTML = '<option value="" disabled selected>Select Tag Value</option>';
        
        if (selectedType && tagValues[selectedType]) {
            tagValues[selectedType].forEach(tag => {
                const option = document.createElement('option');
                option.value = tag.id;
                option.textContent = tag.value;
                valueSelect.appendChild(option);
            });
        }
    }

    function addTagRow(btn) {
        const container = document.getElementById('tagSelectionContainer');
        const newRow = createTagRow();
        container.appendChild(newRow);
    }

    function removeTagRow(btn) {
        const row = btn.closest('.tag-selection-row');
        const container = document.getElementById('tagSelectionContainer');
        const rows = container.querySelectorAll('.tag-selection-row');
        
        row.remove();
        
        if (container.querySelectorAll('.tag-selection-row').length === 0) {
            const newRow = createTagRow();
            container.appendChild(newRow);
        }
    }

    async function saveAllTags() {
        const projectId = new URLSearchParams(window.location.search).get('id');
        const userInfo = JSON.parse(localStorage.getItem('userInfo'));
        const rows = document.querySelectorAll('.tag-selection-row');
        const tags = [];

        rows.forEach(row => {
            const valueSelect = row.querySelector('.tag-value-select');
            if (valueSelect.value) {
                tags.push({
                    projectId: parseInt(projectId),
                    tagValueId: parseInt(valueSelect.value),
                    professorId: userInfo.id
                });
            }
        });

        try {
            await deleteAllProjectTags(projectId);

            for (const tag of tags) {
                await fetch(`${API_BASE_URL}/project/tag`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(tag)
                });
            }

            // Show success message in a popup
            const popup = document.createElement('div');
            popup.className = 'popup-message';
            popup.innerHTML = `
                <div class="popup-content">
                    <p>Changes have been saved.</p>
                    <button onclick="this.parentElement.parentElement.remove()">OK</button>
                </div>
            `;
            document.body.appendChild(popup);
            
            loadProjectTags();
        } catch (error) {
            console.error('Error saving tags:', error);
            const popup = document.createElement('div');
            popup.className = 'popup-message';
            popup.innerHTML = `
                <div class="popup-content">
                    <p>Error saving tags</p>
                    <button onclick="this.parentElement.parentElement.remove()">OK</button>
                </div>
            `;
            document.body.appendChild(popup);
        }
    }

    async function deleteAllProjectTags(projectId) {
        try {
            const response = await fetch(`${API_BASE_URL}/project/${projectId}`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            });
            const data = await response.json();
            const existingTags = data.tags || [];

            for (const tag of existingTags) {
                await fetch(`${API_BASE_URL}/project/tag/${tag.id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
            }
        } catch (error) {
            console.error('Error deleting existing tags:', error);
            throw error;
        }
    }

    async function loadProjectTags() {
        const projectId = new URLSearchParams(window.location.search).get('id');
        try {
            const response = await fetch(`${API_BASE_URL}/project/${projectId}`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            });
            const data = await response.json();
            console.log('Project Data:', data);
            
            // Get project tags from the project data
            if (data.tags && data.tags.length > 0) {
                currentProjectTags = data.tags.map(tag => ({
                    tagType: tag.tagType,
                    tagValueId: tag.id,
                    tagValue: tag.value
                }));
                console.log('Current Project Tags:', currentProjectTags);
                await loadTagTypes();
                displayProjectTags();
            } else {
                const container = document.getElementById('tagSelectionContainer');
                container.innerHTML = '';
                const row = createTagRow();
                container.appendChild(row);
            }
        } catch (error) {
            console.error('Error loading project tags:', error);
        }
    }

    function displayProjectTags() {
        const container = document.getElementById('tagSelectionContainer');
        container.innerHTML = ''; 

        // Displayexisting tags
        if (currentProjectTags && currentProjectTags.length > 0) {
            currentProjectTags.forEach((tag, index) => {
                const row = createTagRow();
                const typeSelect = row.querySelector('.tag-type-select');
                const valueSelect = row.querySelector('.tag-value-select');
                const removeBtn = row.querySelector('.remove-tag-btn');

                console.log('Processing tag:', tag);
                console.log('Available tag types:', Object.keys(tagValues));
                console.log('Tag Type:', tag.tagType);
                console.log('Tag Value:', tag.tagValue);

                typeSelect.value = tag.tagType;
                typeSelect.dispatchEvent(new Event('change'));
                
                setTimeout(() => {
                    const options = Array.from(valueSelect.options);
                    const matchingOption = options.find(opt => opt.text === tag.tagValue);
                    if (matchingOption) {
                        valueSelect.value = matchingOption.value;
                    }
                    console.log('Value select options:', options.map(opt => ({value: opt.value, text: opt.text})));
                    console.log('Set value select:', valueSelect.value);
                }, 100);

                removeBtn.style.display = 'block';

                container.appendChild(row);
            });
        } else {
            const row = createTagRow();
            container.appendChild(row);
        }
    }

    function createTagRow() {
        const row = document.createElement('div');
        row.className = 'tag-selection-row';
        row.innerHTML = `
            <div class="tag-type-container">
                <select class="tag-type-select">
                    <option value="" disabled selected>Select Tag Type</option>
                </select>
            </div>
            <div class="tag-value-container">
                <div class="tag-value-group">
                    <select class="tag-value-select">
                        <option value="" disabled selected>Select Tag Value</option>
                    </select>
                    <button class="add-tag-btn" onclick="addTagRow(this)">+</button>
                    <button class="remove-tag-btn" onclick="removeTagRow(this)">−</button>
                </div>
            </div>
        `;

        const typeSelect = row.querySelector('.tag-type-select');
        typeSelect.addEventListener('change', (e) => updateTagValueSelect(e.target));

        Object.keys(tagValues).forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = type;
            typeSelect.appendChild(option);
        });

        return row;
    }

    async function deleteTag(tagId) {
        try {
            const response = await fetch(`${API_BASE_URL}/project/tag/${tagId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            });

            if (response.ok) {
                await loadProjectTags();
                document.getElementById('message').innerHTML = '<p class="success">Tag deleted successfully!</p>';
            } else {
                const error = await response.json();
                document.getElementById('message').innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        } catch (error) {
            console.error('Error deleting tag:', error);
            document.getElementById('message').innerHTML = '<p class="error">Error deleting tag</p>';
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const typeSelects = document.querySelectorAll('.tag-type-select');
        typeSelects.forEach(select => {
            select.addEventListener('change', (e) => updateTagValueSelect(e.target));
        });
    });
</script>
</body>
</html> 